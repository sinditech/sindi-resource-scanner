# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path
name: Sindi Resource Scanner - Publish

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      skip_tests:
        description: 'Skip running tests before deploy?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
    

jobs:
  publish:
    # if: github.event.pull_request.merged == true
    name: Release on MavenCentral
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for creating a release if you automate that part
      packages: write # Needed if you also push to GitHub Packages

    steps:
      - name: Step 1 - Checkout code
        uses: actions/checkout@v4

      - name: Step 2 - Set up Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '17' # Or your desired Java version
          distribution: 'temurin'
          cache: 'maven'
          # Important: This configures settings.xml for you
          # It looks for the server ID 'central' by default
          # and uses MAVEN_USERNAME/MAVEN_PASSWORD environment variables
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-passphrase: MAVEN_GPG_PASSPHRASE
      - run: |
          git config --global user.name 'Buhake Sindi'
          git config --global user.email 'buhake@gmail.com'

      - name: Step 3 - Import GPG secret key
        run: |
          cat <(echo -e "${{ secrets.MAVEN_GPG_PRIVATE_KEY }}") | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG
        env:
          MAVEN_GPG_PRIVATE_KEY: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          
      - name: Step 4 - Generate and update CHANGELOG.md
        id: changelog
        run: |
          VERSION=${{ github.event.inputs.release_version }}
          DATE=$(date +'%Y-%m-%d')

          # Find previous tag (if any)
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Collect release commits only
          if [ -z "$PREVIOUS_TAG" ]; then
            git log --pretty=format:"%s" \
              | grep '^release:' \
              | sed 's/^release: */- /' > RELEASE_NOTES.md
          else
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s" \
              | grep '^release:' \
              | sed 's/^release: */- /' > RELEASE_NOTES.md
          fi

          # Fallback for first release
          if [ ! -s RELEASE_NOTES.md ]; then
            echo "- Initial release" > RELEASE_NOTES.md
          fi

          # Prepare changelog section
          {
            echo "## [$VERSION] - $DATE"
            cat RELEASE_NOTES.md
            echo ""
          } > NEW_CHANGELOG_SECTION.md

          # Create CHANGELOG.md if missing
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Insert new section at the top (after title)
          awk '
            NR==1 { print; print ""; system("cat NEW_CHANGELOG_SECTION.md"); next }
            { print }
          ' CHANGELOG.md > CHANGELOG.tmp

          mv CHANGELOG.tmp CHANGELOG.md

          # Expose changelog for GitHub Release
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat RELEASE_NOTES.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Step 5 - Commit CHANGELOG.md
        run: |
          git add CHANGELOG.md
          git commit -m "docs(changelog): release v${{ github.event.inputs.release_version }}" || echo "No changes to commit"
          git push

      - name: Step 6 - Set release version
        run: mvn versions:set -DnewVersion=${{ github.event.inputs.release_version }} -DgenerateBackupPoms=false

      - name: Step 7 - Confirm version
        run: mvn help:evaluate -Dexpression=project.version -q -DforceStdout

      - name: Step 8 - Publish package
        run: |
          if [ "${{ github.event.inputs.skip_tests }}" == "true" ]; then
            mvn --batch-mode deploy -DskipTests -DskipITs -Dspotless.check.skip=true -Psign -e # -P release if you use a profile for release builds
          else
            mvn clean verify deploy -P release -B -U --no-transfer-progress
          fi
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }} # Passed to the GPG plugin

      - name: Step 9 - Create Git tag for release
        run: |
          VERSION=${{ github.event.inputs.release_version }}
          git tag -a "v$VERSION" -m "Release version $VERSION"
          git push origin "v$VERSION"
          
      - name: Step 10 - Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.release_version }}
          name: Release v${{ github.event.inputs.release_version }}
          body: |
            ${{ steps.changelog.outputs.changelog }}
